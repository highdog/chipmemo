<!--pages/notes/notes.wxml-->
<view class="container">
  <!-- å¤´éƒ¨å·¥å…·æ  -->
  <view class="header-toolbar">
    <view class="toolbar-left">
      <text class="page-title">{{selectionMode ? 'é€‰æ‹©ç¬”è®°' : 'æˆ‘çš„ç¬”è®°'}}</text>
      <text class="notes-count" wx:if="{{!selectionMode}}">({{pagination.total}})</text>
    </view>
    
    <view class="toolbar-right">
      <!-- æœç´¢æŒ‰é’® -->
      <view class="tool-btn" bindtap="toggleSearch" wx:if="{{!selectionMode}}">
        <text class="tool-icon">ğŸ”</text>
      </view>
      
      <!-- ç­›é€‰æŒ‰é’® -->
      <view class="tool-btn" bindtap="toggleFilter" wx:if="{{!selectionMode}}">
        <text class="tool-icon">ğŸ”½</text>
      </view>
      
      <!-- é€‰æ‹©æ¨¡å¼æŒ‰é’® -->
      <view class="tool-btn" bindtap="toggleSelectionMode" wx:if="{{!selectionMode && notes.length > 0}}">
        <text class="tool-icon">â˜‘ï¸</text>
      </view>
      
      <!-- å–æ¶ˆé€‰æ‹© -->
      <view class="tool-btn" bindtap="toggleSelectionMode" wx:if="{{selectionMode}}">
        <text class="tool-text">å–æ¶ˆ</text>
      </view>
    </view>
  </view>

  <!-- æœç´¢æ  -->
  <view class="search-bar {{showSearch ? 'show' : ''}}">
    <view class="search-input-wrapper">
      <input
        class="search-input"
        type="text"
        placeholder="æœç´¢ç¬”è®°å†…å®¹æˆ–æ ‡ç­¾"
        value="{{searchQuery}}"
        bindinput="onSearchInput"
        focus="{{showSearch}}"
      />
      <view class="search-icon">ğŸ”</view>
      <view class="clear-btn" bindtap="clearSearch" wx:if="{{searchQuery}}">
        <text>âœ•</text>
      </view>
    </view>
  </view>

  <!-- ç­›é€‰é¢æ¿ -->
  <view class="filter-panel {{showFilter ? 'show' : ''}}">
    <!-- æ ‡ç­¾ç­›é€‰ -->
    <view class="filter-section">
      <text class="filter-title">æ ‡ç­¾ç­›é€‰</text>
      <view class="tag-list">
        <view 
          class="filter-tag {{selectedTag === '' ? 'active' : ''}}"
          bindtap="selectTag"
          data-tag=""
        >
          å…¨éƒ¨
        </view>
        <view 
          class="filter-tag {{selectedTag === item ? 'active' : ''}}"
          wx:for="{{allTags}}"
          wx:key="*this"
          bindtap="selectTag"
          data-tag="{{item}}"
        >
          {{item}}
        </view>
      </view>
    </view>
    
    <!-- æ’åºé€‰é¡¹ -->
    <view class="filter-section">
      <text class="filter-title">æ’åºæ–¹å¼</text>
      <view class="sort-list">
        <view 
          class="sort-option {{sortBy === item.key && sortOrder === item.order ? 'active' : ''}}"
          wx:for="{{sortOptions}}"
          wx:key="key"
          bindtap="selectSort"
          data-key="{{item.key}}"
          data-order="{{item.order}}"
        >
          {{item.label}}
        </view>
      </view>
    </view>
    
    <!-- å…¶ä»–é€‰é¡¹ -->
    <view class="filter-section">
      <view class="filter-option" bindtap="toggleArchived">
        <text>æ˜¾ç¤ºå·²å½’æ¡£</text>
        <view class="toggle {{showArchived ? 'active' : ''}}">
          <view class="toggle-thumb"></view>
        </view>
      </view>
    </view>
  </view>

  <!-- é€‰æ‹©æ¨¡å¼å·¥å…·æ  -->
  <view class="selection-toolbar" wx:if="{{selectionMode}}">
    <view class="selection-info">
      <text>å·²é€‰æ‹© {{selectedNotes.length}} é¡¹</text>
    </view>
    <view class="selection-actions">
      <button class="btn btn-outline btn-small" bindtap="toggleSelectAll">
        {{selectedNotes.length === notes.length ? 'å–æ¶ˆå…¨é€‰' : 'å…¨é€‰'}}
      </button>
      <button 
        class="btn btn-danger btn-small" 
        bindtap="batchDelete"
        disabled="{{selectedNotes.length === 0}}"
      >
        åˆ é™¤
      </button>
    </view>
  </view>

  <!-- ç¬”è®°åˆ—è¡¨ -->
  <scroll-view 
    class="notes-scroll"
    scroll-y
    refresher-enabled
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    bindscrolltolower="onReachBottom"
  >
    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{loading}}" class="loading">
      <view class="loading-spinner"></view>
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- ç¬”è®°åˆ—è¡¨ -->
    <view wx:elif="{{notes.length > 0}}" class="notes-list">
      <view 
        class="note-item {{selectionMode ? 'selection-mode' : ''}} {{selectedNotes.includes(item._id) ? 'selected' : ''}}"
        wx:for="{{notes}}"
        wx:key="_id"
        data-id="{{item._id}}"
        data-title="{{item.title}}"
        bindtap="goToNoteDetail"
      >
        <!-- é€‰æ‹©æ¡† -->
        <view class="selection-checkbox" wx:if="{{selectionMode}}">
          <view class="checkbox {{selectedNotes.includes(item._id) ? 'checked' : ''}}">
            <text wx:if="{{selectedNotes.includes(item._id)}}">âœ“</text>
          </view>
        </view>
        
        <!-- ç¬”è®°å†…å®¹ -->
        <view class="note-content">
          <view class="note-header">
            <text class="note-title">{{item.title || 'æ— æ ‡é¢˜'}}</text>
            <text class="note-date">{{item.formattedDate}}</text>
          </view>
          
          <view class="note-preview" wx:if="{{item.truncatedContent}}">
            <text>{{item.truncatedContent}}</text>
          </view>
          
          <view class="note-footer">
            <!-- æ ‡ç­¾ -->
            <view class="note-tags" wx:if="{{item.tags && item.tags.length > 0}}">
              <text 
                class="tag tag-small"
                wx:for="{{item.tags}}"
                wx:for-item="tag"
                wx:key="*this"
              >
                {{tag}}
              </text>
            </view>
            
            <!-- æ“ä½œæŒ‰é’® -->
            <view class="note-actions" wx:if="{{!selectionMode}}">
              <view 
                class="action-btn"
                bindtap="shareNote"
                data-id="{{item._id}}"
                data-title="{{item.title}}"
              >
                <text>ğŸ“¤</text>
              </view>
              <view 
                class="action-btn delete-btn"
                bindtap="deleteNote"
                data-id="{{item._id}}"
                data-title="{{item.title}}"
              >
                <text>ğŸ—‘ï¸</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:elif="{{!loading}}" class="empty-state">
      <view class="empty-icon">ğŸ“</view>
      <text class="empty-text">
        {{searchQuery ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³ç¬”è®°' : 'è¿˜æ²¡æœ‰ç¬”è®°'}}
      </text>
      <text class="empty-subtext">
        {{searchQuery ? 'è¯•è¯•å…¶ä»–å…³é”®è¯' : 'ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®å¼€å§‹è®°å½•'}}
      </text>
      <button 
        class="btn btn-primary margin-top"
        bindtap="goToAddNote"
        wx:if="{{!searchQuery}}"
      >
        åˆ›å»ºç¬¬ä¸€ç¯‡ç¬”è®°
      </button>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{loadingMore}}" class="loading-more">
      <view class="loading-spinner"></view>
      <text>åŠ è½½æ›´å¤š...</text>
    </view>
    
    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:elif="{{notes.length > 0 && !pagination.hasMore}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šç¬”è®°äº†</text>
    </view>
  </scroll-view>

  <!-- æµ®åŠ¨æ·»åŠ æŒ‰é’® -->
  <view class="fab" bindtap="goToAddNote" wx:if="{{!selectionMode}}">
    <text class="fab-icon">âœï¸</text>
  </view>
</view>