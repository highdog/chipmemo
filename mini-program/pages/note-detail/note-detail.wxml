<!--pages/note-detail/note-detail.wxml-->
<view class="note-detail-container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯çŠ¶æ€ -->
  <view wx:elif="{{error}}" class="error-container">
    <view class="error-icon">âš ï¸</view>
    <text class="error-message">{{error}}</text>
    <button class="retry-btn" bindtap="retryLoad">é‡è¯•</button>
  </view>

  <!-- ç¬”è®°å†…å®¹ -->
  <view wx:elif="{{note}}" class="note-content">
    <!-- å¤´éƒ¨å·¥å…·æ  -->
    <view class="header-toolbar">
      <view class="header-left">
        <button class="back-btn" bindtap="goBack">
          <text class="icon">â†</text>
        </button>
      </view>
      
      <view class="header-center">
        <text class="page-title">ç¬”è®°è¯¦æƒ…</text>
      </view>
      
      <view class="header-right">
        <button wx:if="{{!isEditing}}" class="action-btn" bindtap="toggleActions">
          <text class="icon">â‹¯</text>
        </button>
        <view wx:else class="edit-actions">
          <button class="cancel-btn" bindtap="exitEditMode">å–æ¶ˆ</button>
          <button class="save-btn" bindtap="saveEdit">ä¿å­˜</button>
        </view>
      </view>
    </view>

    <!-- æ“ä½œèœå• -->
    <view wx:if="{{showActions}}" class="actions-overlay" bindtap="hideActions">
      <view class="actions-menu" catchtap="">
        <view class="action-item" bindtap="enterEditMode">
          <text class="action-icon">âœï¸</text>
          <text class="action-text">ç¼–è¾‘</text>
        </view>
        <view class="action-item" bindtap="copyContent">
          <text class="action-icon">ğŸ“‹</text>
          <text class="action-text">å¤åˆ¶</text>
        </view>
        <view class="action-item" bindtap="showShareModal">
          <text class="action-icon">ğŸ“¤</text>
          <text class="action-text">åˆ†äº«</text>
        </view>
        <view class="action-item" bindtap="toggleArchive">
          <text class="action-icon">{{note.archived ? 'ğŸ“‚' : 'ğŸ—ƒï¸'}}</text>
          <text class="action-text">{{note.archived ? 'å–æ¶ˆå½’æ¡£' : 'å½’æ¡£'}}</text>
        </view>
        <view class="action-item danger" bindtap="deleteNote">
          <text class="action-icon">ğŸ—‘ï¸</text>
          <text class="action-text">åˆ é™¤</text>
        </view>
      </view>
    </view>

    <!-- ç¬”è®°ä¸»ä½“ -->
    <scroll-view class="note-scroll" scroll-y enhanced>
      <!-- éç¼–è¾‘æ¨¡å¼ -->
      <view wx:if="{{!isEditing}}" class="note-view">
        <!-- ç¬”è®°æ ‡é¢˜ -->
        <view class="note-title-section">
          <text class="note-title">{{note.title}}</text>
          <view wx:if="{{note.archived}}" class="archived-badge">
            <text>å·²å½’æ¡£</text>
          </view>
        </view>

        <!-- ç¬”è®°å…ƒä¿¡æ¯ -->
        <view class="note-meta">
          <view class="meta-item">
            <text class="meta-label">åˆ›å»ºæ—¶é—´:</text>
            <text class="meta-value">{{note.createdAt}}</text>
          </view>
          <view wx:if="{{note.updatedAt !== note.createdAt}}" class="meta-item">
            <text class="meta-label">æ›´æ–°æ—¶é—´:</text>
            <text class="meta-value">{{note.updatedAt}}</text>
          </view>
          <view wx:if="{{note.tags && note.tags.length > 0}}" class="meta-item">
            <text class="meta-label">æ ‡ç­¾:</text>
            <view class="tags-container">
              <text wx:for="{{note.tags}}" wx:key="*this" class="tag">{{item}}</text>
            </view>
          </view>
        </view>

        <!-- ç¬”è®°å†…å®¹ -->
        <view class="note-content-section">
          <text class="note-text" decode="{{true}}">{{note.content}}</text>
        </view>

        <!-- ç¬”è®°é™„ä»¶ -->
        <view wx:if="{{note.attachments && note.attachments.length > 0}}" class="attachments-section">
          <text class="section-title">é™„ä»¶</text>
          <view class="attachments-grid">
            <view wx:for="{{note.attachments}}" wx:key="id" class="attachment-item">
              <image wx:if="{{item.type === 'image'}}" 
                     class="attachment-image" 
                     src="{{item.url}}" 
                     mode="aspectFill"
                     bindtap="previewImage"
                     data-url="{{item.url}}"></image>
              <view wx:else class="attachment-file">
                <text class="file-icon">ğŸ“„</text>
                <text class="file-name">{{item.name}}</text>
              </view>
            </view>
          </view>
        </view>
      </view>

      <!-- ç¼–è¾‘æ¨¡å¼ -->
      <view wx:else class="note-edit">
        <!-- æ ‡é¢˜ç¼–è¾‘ -->
        <view class="edit-section">
          <text class="edit-label">æ ‡é¢˜</text>
          <input class="title-input" 
                 value="{{editTitle}}" 
                 placeholder="è¯·è¾“å…¥æ ‡é¢˜"
                 bindinput="onTitleInput"
                 maxlength="100"></input>
        </view>

        <!-- æ ‡ç­¾ç¼–è¾‘ -->
        <view class="edit-section">
          <view class="section-header">
            <text class="edit-label">æ ‡ç­¾</text>
            <button class="add-tag-btn" bindtap="showTagInput">+ æ·»åŠ </button>
          </view>
          
          <view wx:if="{{editTags.length > 0}}" class="edit-tags">
            <view wx:for="{{editTags}}" wx:key="*this" class="edit-tag">
              <text class="tag-text">{{item}}</text>
              <button class="remove-tag-btn" bindtap="removeTag" data-index="{{index}}">Ã—</button>
            </view>
          </view>
          
          <view wx:if="{{showTagInput}}" class="tag-input-section">
            <input class="tag-input" 
                   value="{{tagInput}}" 
                   placeholder="è¾“å…¥æ ‡ç­¾åç§°"
                   bindinput="onTagInput"
                   maxlength="20"></input>
            <button class="confirm-tag-btn" bindtap="addTag">ç¡®å®š</button>
            <button class="cancel-tag-btn" bindtap="hideTagInput">å–æ¶ˆ</button>
          </view>
        </view>

        <!-- å†…å®¹ç¼–è¾‘ -->
        <view class="edit-section">
          <text class="edit-label">å†…å®¹</text>
          <textarea class="content-textarea" 
                    value="{{editContent}}" 
                    placeholder="è¯·è¾“å…¥ç¬”è®°å†…å®¹"
                    bindinput="onContentInput"
                    auto-height
                    maxlength="10000"></textarea>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- åˆ†äº«å¼¹çª— -->
  <view wx:if="{{shareModalVisible}}" class="share-modal-overlay" bindtap="hideShareModal">
    <view class="share-modal" catchtap="">
      <view class="modal-header">
        <text class="modal-title">åˆ†äº«ç¬”è®°</text>
        <button class="modal-close" bindtap="hideShareModal">Ã—</button>
      </view>
      
      <view class="share-options">
        <view wx:for="{{shareOptions}}" wx:key="key" 
              class="share-option" 
              bindtap="handleShare" 
              data-type="{{item.key}}">
          <view class="option-icon">{{item.icon === 'copy' ? 'ğŸ“‹' : item.icon === 'qr' ? 'ğŸ“±' : 'ğŸ’¬'}}</view>
          <text class="option-title">{{item.title}}</text>
        </view>
      </view>
    </view>
  </view>
</view>